 # Copyright © 2022 Sam Varner
#
# This file is part of R-packages, a collection of R code that I find useful.
#
# R-packages is free software: you can redistribute it and/or modify it under the terms
# of the GNU General Public License as published by the Free Software Foundation, either
# version 3 of the License, or (at your option) any later version.
#
# R-packages is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
# without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
# PURPOSE.  See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with R-packages
# If not, see <http://www.gnu.org/licenses/>.

# This file defines functions for signal processing.

#' Return a copy of the vector x with offset removed.
#'
#' @param x The original vector
#' @param func A function that returns the offset when applied to x. The default function
#' is first(). I.e. calling with no arguments returns x - x[1].
#'
#' @export
#'
#' @examples
#' zero(c(1,2,4,8,16))
#' zero(c(1,2,4,8,16), mean)
zero <- function(x, func=first) {
    x - func(x)
}

#' Return a copy of the vector x with drift and offset removed.
#'
#' @param x The original vector.
#' @return The result of subtracting a LOWESS smooth of x from x.
#' @export
flat <- function(x) {
    t <- 1:length(x)
    smooth <- loess(x ~ t)
    x - predict(smooth, t)
}

#' Return simple statistics in a list.
#'
#' @return A list of mean, standard deviation, maximum, minimum, and span.
#' @export
stats <- function(x) {
    min <- min(x)
    max <- max(x)
    list(mean=mean(x), sd=sd(x), min=min(x), max=max(x), span=max - min)
}

#' Return difference, fractional error, and percent error
#' @export
errors <- function(meas, act) {
    delta <- meas - act
    frac <- delta/act
    list(delta=delta, frac=frac, pct=100*frac)
}

#' Return the difference between the highest and lowest values of x.
#' @export
span <- function(x) {
    diff(range(x))
}

#' Normalize a vector by subtracting an offset and multiplying by a scale. With default
#' arguments the returned vector has a minimum of 0 and maximum of 1.
#' @param offset A function that gives the offset when applied to x
#' @param scale A function that gives the scale when applied to x
normalize <- function(x, offset = min, scale = span) {
    (x - offset(x)) / scale(x)
}

#' Normalize the signal to its standard deviation. Useful for preparing a qq-plot.
#' @export
norm.sd <- function(x) {
    normalize(x, mean, sd)
}

#' Return a vector of integers to index the columns of data frame d.
#' @export
index <- function(d) {
    1:nrow(d)
}

#' Return the distribution of point-to-point differences.
#' @export
steps <- function(x) {
    sort(unique(abs(diff(x))))
}

#' Returns the separation if x is bimodal with negligible overlap,
#' Warning: Does not test for bimodality.
bimode <- function(x) {
    avg <- mean(x)
    mean(x[x >= avg]) - mean(x[x < avg])
}
#' @export
change <- function(x) {
    c(FALSE, diff(x) != 0)
}

#' 1000 ohm Pt RTD resistance for temperatures from -200 °C to 962 °C in 1 °C
#' increments. The table is from cad1kRTDResist in dm643lib/hwtemp.cpp.
rtd.ohm <- c(
    185.261,	189.582,	193.900,	198.214,	202.524,	206.831,	211.134,	215.434,	219.730,	224.023,
    228.312,	232.598,	236.880,	241.159,	245.435,	249.707,	253.976,	258.241,	262.504,	266.763,
    271.018,	275.271,	279.520,	283.766,	288.009,	292.249,	296.486,	300.719,	304.950,	309.177,
    313.401,	317.623,	321.841,	326.056,	330.269,	334.478,	338.685,	342.888,	347.089,	351.286,
    355.481,	359.673,	363.863,	368.049,	372.233,	376.413,	380.592,	384.767,	388.940,	393.110,
    397.277,	401.441,	405.603,	409.763,	413.920,	418.074,	422.225,	426.374,	430.521,	434.665,
    438.806,	442.945,	447.082,	451.216,	455.347,	459.477,	463.603,	467.728,	471.850,	475.969,
    480.087,	484.201,	488.314,	492.424,	496.533,	500.638,	504.742,	508.843,	512.942,	517.039,
    521.134,	525.226,	529.317,	533.405,	537.491,	541.575,	545.657,	549.736,	553.814,	557.890,
    561.963,	566.035,	570.104,	574.171,	578.237,	582.300,	586.362,	590.421,	594.479,	598.535,
    602.588,	606.640,	610.690,	614.738,	618.784,	622.829,	626.871,	630.912,	634.951,	638.988,
    643.023,	647.056,	651.088,	655.118,	659.146,	663.172,	667.197,	671.220,	675.241,	679.261,
    683.278,	687.295,	691.309,	695.322,	699.333,	703.343,	707.351,	711.357,	715.362,	719.365,
    723.366,	727.366,	731.365,	735.362,	739.357,	743.351,	747.343,	751.333,	755.323,	759.310,
    763.296,	767.281,	771.264,	775.246,	779.226,	783.205,	787.183,	791.159,	795.133,	799.106,
    803.078,	807.048,	811.017,	814.984,	818.951,	822.915,	826.879,	830.841,	834.801,	838.761,
    842.719,	846.675,	850.630,	854.584,	858.537,	862.488,	866.438,	870.387,	874.335,	878.281,
    882.226,	886.169,	890.111,	894.053,	897.992,	901.931,	905.868,	909.804,	913.739,	917.673,
    921.605,	925.536,	929.466,	933.395,	937.322,	941.248,	945.174,	949.097,	953.020,	956.942,
    960.862,	964.781,	968.699,	972.616,	976.531,	980.446,	984.359,	988.271,	992.182,	996.091,
    1000.000,	1003.907,	1007.814,	1011.719,	1015.623,	1019.526,	1023.427,	1027.328,	1031.227,	1035.125,
    1039.022,	1042.918,	1046.813,	1050.706,	1054.599,	1058.490,	1062.380,	1066.269,	1070.157,	1074.044,
    1077.929,	1081.813,	1085.696,	1089.579,	1093.459,	1097.339,	1101.218,	1105.095,	1108.971,	1112.846,
    1116.720,	1120.593,	1124.465,	1128.335,	1132.204,	1136.073,	1139.940,	1143.805,	1147.670,	1151.534,
    1155.396,	1159.257,	1163.117,	1166.976,	1170.834,	1174.691,	1178.546,	1182.400,	1186.253,	1190.105,
    1193.956,	1197.806,	1201.654,	1205.502,	1209.348,	1213.193,	1217.037,	1220.880,	1224.721,	1228.562,
    1232.401,	1236.239,	1240.076,	1243.912,	1247.747,	1251.580,	1255.412,	1259.244,	1263.074,	1266.903,
    1270.730,	1274.557,	1278.382,	1282.207,	1286.030,	1289.852,	1293.672,	1297.492,	1301.310,	1305.128,
    1308.944,	1312.759,	1316.573,	1320.386,	1324.197,	1328.008,	1331.817,	1335.625,	1339.432,	1343.238,
    1347.042,	1350.846,	1354.648,	1358.449,	1362.249,	1366.048,	1369.846,	1373.642,	1377.438,	1381.232,
    1385.025,	1388.817,	1392.608,	1396.397,	1400.186,	1403.973,	1407.759,	1411.544,	1415.328,	1419.111,
    1422.892,	1426.673,	1430.452,	1434.230,	1438.007,	1441.783,	1445.557,	1449.331,	1453.103,	1456.874,
    1460.644,	1464.413,	1468.180,	1471.947,	1475.712,	1479.477,	1483.240,	1487.002,	1490.762,	1494.522,
    1498.280,	1502.038,	1505.794,	1509.549,	1513.302,	1517.055,	1520.807,	1524.557,	1528.306,	1532.054,
    1535.801,	1539.547,	1543.291,	1547.035,	1550.777,	1554.518,	1558.258,	1561.997,	1565.734,	1569.471,
    1573.206,	1576.940,	1580.673,	1584.405,	1588.136,	1591.866,	1595.594,	1599.321,	1603.047,	1606.772,
    1610.496,	1614.219,	1617.940,	1621.660,	1625.380,	1629.098,	1632.814,	1636.530,	1640.245,	1643.958,
    1647.670,	1651.381,	1655.091,	1658.800,	1662.508,	1666.214,	1669.919,	1673.624,	1677.326,	1681.028,
    1684.729,	1688.429,	1692.127,	1695.824,	1699.520,	1703.215,	1706.909,	1710.601,	1714.293,	1717.983,
    1721.672,	1725.360,	1729.047,	1732.733,	1736.417,	1740.101,	1743.783,	1747.464,	1751.144,	1754.822,
    1758.500,	1762.176,	1765.852,	1769.526,	1773.199,	1776.871,	1780.541,	1784.211,	1787.879,	1791.546,
    1795.212,	1798.877,	1802.541,	1806.203,	1809.865,	1813.525,	1817.184,	1820.842,	1824.499,	1828.155,
    1831.809,	1835.462,	1839.114,	1842.766,	1846.415,	1850.064,	1853.712,	1857.358,	1861.003,	1864.647,
    1868.290,	1871.932,	1875.573,	1879.212,	1882.850,	1886.488,	1890.124,	1893.758,	1897.392,	1901.025,
    1904.656,	1908.286,	1911.915,	1915.543,	1919.170,	1922.796,	1926.420,	1930.043,	1933.665,	1937.286,
    1940.906,	1944.525,	1948.142,	1951.759,	1955.374,	1958.988,	1962.601,	1966.213,	1969.823,	1973.433,
    1977.041,	1980.648,	1984.254,	1987.859,	1991.463,	1995.065,	1998.666,	2002.267,	2005.866,	2009.464,
    2013.060,	2016.656,	2020.250,	2023.844,	2027.436,	2031.027,	2034.616,	2038.205,	2041.792,	2045.379,
    2048.964,	2052.548,	2056.131,	2059.713,	2063.293,	2066.873,	2070.451,	2074.028,	2077.604,	2081.179,
    2084.752,	2088.325,	2091.896,	2095.466,	2099.035,	2102.603,	2106.170,	2109.735,	2113.300,	2116.863,
    2120.425,	2123.986,	2127.546,	2131.104,	2134.662,	2138.218,	2141.773,	2145.327,	2148.880,	2152.432,
    2155.982,	2159.532,	2163.080,	2166.627,	2170.173,	2173.718,	2177.261,	2180.804,	2184.345,	2187.885,
    2191.424,	2194.962,	2198.498,	2202.034,	2205.568,	2209.102,	2212.634,	2216.165,	2219.694,	2223.223,
    2226.750,	2230.277,	2233.802,	2237.326,	2240.848,	2244.370,	2247.891,	2251.410,	2254.928,	2258.445,
    2261.961,	2265.476,	2268.989,	2272.502,	2276.013,	2279.523,	2283.032,	2286.540,	2290.046,	2293.552,
    2297.056,	2300.559,	2304.061,	2307.562,	2311.062,	2314.561,	2318.058,	2321.554,	2325.049,	2328.543,
    2332.036,	2335.528,	2339.018,	2342.507,	2345.996,	2349.483,	2352.968,	2356.453,	2359.937,	2363.419,
    2366.900,	2370.380,	2373.859,	2377.337,	2380.814,	2384.289,	2387.763,	2391.237,	2394.708,	2398.179,
    2401.649,	2405.118,	2408.585,	2412.051,	2415.516,	2418.980,	2422.443,	2425.904,	2429.365,	2432.824,
    2436.282,	2439.739,	2443.195,	2446.650,	2450.103,	2453.556,	2457.007,	2460.457,	2463.906,	2467.353,
    2470.800,	2474.245,	2477.690,	2481.133,	2484.575,	2488.016,	2491.455,	2494.894,	2498.331,	2501.767,
    2505.202,	2508.636,	2512.069,	2515.500,	2518.931,	2522.360,	2525.788,	2529.215,	2532.641,	2536.066,
    2539.489,	2542.911,	2546.332,	2549.753,	2553.171,	2556.589,	2560.006,	2563.421,	2566.835,	2570.248,
    2573.660,	2577.071,	2580.481,	2583.889,	2587.296,	2590.703,	2594.108,	2597.511,	2600.914,	2604.316,
    2607.716,	2611.115,	2614.513,	2617.910,	2621.306,	2624.701,	2628.094,	2631.486,	2634.877,	2638.267,
    2641.656,	2645.044,	2648.430,	2651.816,	2655.200,	2658.583,	2661.965,	2665.346,	2668.725,	2672.104,
    2675.481,	2678.857,	2682.232,	2685.606,	2688.979,	2692.350,	2695.720,	2699.090,	2702.458,	2705.825,
    2709.190,	2712.555,	2715.918,	2719.281,	2722.642,	2726.002,	2729.360,	2732.718,	2736.074,	2739.430,
    2742.784,	2746.137,	2749.489,	2752.840,	2756.189,	2759.538,	2762.885,	2766.231,	2769.576,	2772.920,
    2776.262,	2779.604,	2782.944,	2786.283,	2789.621,	2792.958,	2796.294,	2799.628,	2802.962,	2806.294,
    2809.625,	2812.955,	2816.284,	2819.611,	2822.938,	2826.263,	2829.587,	2832.910,	2836.232,	2839.553,
    2842.872,	2846.191,	2849.508,	2852.824,	2856.139,	2859.453,	2862.765,	2866.077,	2869.387,	2872.696,
    2876.004,	2879.311,	2882.616,	2885.921,	2889.224,	2892.527,	2895.828,	2899.128,	2902.426,	2905.724,
    2909.020,	2912.316,	2915.610,	2918.903,	2922.194,	2925.485,	2928.775,	2932.063,	2935.350,	2938.636,
    2941.921,	2945.205,	2948.487,	2951.769,	2955.049,	2958.328,	2961.606,	2964.883,	2968.158,	2971.433,
    2974.706,	2977.978,	2981.249,	2984.519,	2987.788,	2991.056,	2994.322,	2997.587,	3000.851,	3004.114,
    3007.376,	3010.637,	3013.896,	3017.154,	3020.412,	3023.668,	3026.922,	3030.176,	3033.429,	3036.680,
    3039.930,	3043.179,	3046.427,	3049.674,	3052.920,	3056.164,	3059.407,	3062.650,	3065.890,	3069.130,
    3072.369,	3075.607,	3078.843,	3082.078,	3085.312,	3088.545,	3091.777,	3095.007,	3098.237,	3101.465,
    3104.692,	3107.918,	3111.143,	3114.367,	3117.589,	3120.811,	3124.031,	3127.250,	3130.468,	3133.684,
    3136.900,	3140.114,	3143.328,	3146.540,	3149.751,	3152.961,	3156.169,	3159.377,	3162.583,	3165.788,
    3168.992,	3172.195,	3175.397,	3178.597,	3181.797,	3184.995,	3188.192,	3191.388,	3194.583,	3197.777,
    3200.969,	3204.160,	3207.350,	3210.540,	3213.727,	3216.914,	3220.100,	3223.284,	3226.467,	3229.649,
    3232.830,	3236.010,	3239.189,	3242.366,	3245.542,	3248.718,	3251.892,	3255.064,	3258.236,	3261.407,
    3264.576,	3267.744,	3270.911,	3274.077,	3277.242,	3280.406,	3283.568,	3286.729,	3289.889,	3293.048,
    3296.206,	3299.363,	3302.518,	3305.673,	3308.826,	3311.978,	3315.129,	3318.279,	3321.427,	3324.575,
    3327.721,	3330.866,	3334.010,	3337.153,	3340.295,	3343.435,	3346.574,	3349.713,	3352.850,	3355.986,
    3359.120,	3362.254,	3365.386,	3368.518,	3371.648,	3374.777,	3377.904,	3381.031,	3384.156,	3387.281,
    3390.404,	3393.526,	3396.647,	3399.767,	3402.885,	3406.003,	3409.119,	3412.234,	3415.348,	3418.461,
    3421.572,	3424.683,	3427.792,	3430.900,	3434.007,	3437.113,	3440.218,	3443.321,	3446.424,	3449.525,
    3452.625,	3455.724,	3458.822,	3461.918,	3465.014,	3468.108,	3471.201,	3474.293,	3477.384,	3480.474,
    3483.562,	3486.650,	3489.736,	3492.821,	3495.905,	3498.988,	3502.069,	3505.150,	3508.229,	3511.307,
    3514.384,	3517.460,	3520.534,	3523.608,	3526.680,	3529.752,	3532.822,	3535.891,	3538.958,	3542.025,
    3545.090,	3548.155,	3551.218,	3554.280,	3557.340,	3560.400,	3563.459,	3566.516,	3569.572,	3572.627,
    3575.681,	3578.734,	3581.785,	3584.836,	3587.885,	3590.933,	3593.980,	3597.026,	3600.070,	3603.114,
    3606.156,	3609.197,	3612.237,	3615.276,	3618.314,	3621.351,	3624.386,	3627.420,	3630.453,	3633.485,
    3636.516,	3639.546,	3642.574,	3645.601,	3648.628,	3651.653,	3654.676,	3657.699,	3660.721,	3663.741,
    3666.760,	3669.778,	3672.795,	3675.811,	3678.826,	3681.839,	3684.851,	3687.863,	3690.872,	3693.881,
    3696.889,	3699.896,	3702.901,	3705.905,	3708.908,	3711.910,	3714.911,	3717.910,	3720.909,	3723.906,
    3726.902,	3729.897,	3732.891,	3735.884,	3738.875,	3741.866,	3744.855,	3747.843,	3750.830,	3753.815,
    3756.800,	3759.783,	3762.766,	3765.747,	3768.727,	3771.706,	3774.683,	3777.660,	3780.635,	3783.609,
    3786.582,	3789.554,	3792.525,	3795.494,	3798.463,	3801.430,	3804.396,	3807.361,	3810.325,	3813.288,
    3816.249,	3819.209,	3822.168,	3825.127,	3828.083,	3831.039,	3833.994,	3836.947,	3839.899,	3842.850,
    3845.800,	3848.749,	3851.697,	3854.643,	3857.588,	3860.533,	3863.476,	3866.417,	3869.358,	3872.298,
    3875.236,	3878.173,	3881.109,	3884.044,	3886.978,	3889.911,	3892.842,	3895.772,	3898.701,	3901.629,
    3904.556,	3907.482,	3910.406,	3913.330,	3916.252,	3919.173,	3922.093,	3925.012,	3927.929,	3930.846,
    3933.761,	3936.675,	3939.588,	3942.500,	3945.411,	3948.320,	3951.228,	3954.136,	3957.042,	3959.947,
    3962.850,	3965.753,	3968.654,	3971.555,	3974.454,	3977.352,	3980.248,	3983.144,	3986.038,	3988.932,
    3991.824,	3994.715,	3997.605,	4000.494,	4003.381,	4006.268,	4009.153,	4012.037,	4014.920,	4017.802,
    4020.682,	4023.562,	4026.440,	4029.317,	4032.193,	4035.068,	4037.942,	4040.814,	4043.686,	4046.556,
    4049.425,	4052.293,	4055.160,	4058.025,	4060.890,	4063.753,	4066.615,	4069.476,	4072.336,	4075.195,
    4078.052,	4080.909,	4083.764,	4086.618,	4089.471,	4092.323,	4095.173,	4098.023,	4100.871,	4103.718,
    4106.564,	4109.409,	4112.252,	4115.095,	4117.936,	4120.777,	4123.616,	4126.454,	4129.290,	4132.126,
    4134.960,	4137.794,	4140.626,	4143.457,	4146.286,	4149.115,	4151.943,	4154.769,	4157.594,	4160.418,
    4163.241,	4166.063,	4168.883,	4171.703,	4174.521,	4177.338,	4180.154,	4182.969,	4185.782,	4188.595,
    4191.406,	4194.216,	4197.025,	4199.833,	4202.640,	4205.446,	4208.250,	4211.053,	4213.855,	4216.656,
    4219.456,	4222.255,	4225.052)

#' Linear interpolator for temperature vs. resistance.
#' @export
rtd.cal <- approxfun(rtd.ohm, -200:962)
